{% extends "partials/layout.njk" %}
{% from "govuk/components/panel/macro.njk" import govukPanel %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds-from-desktop">

    <h1 class="govuk-heading-l">{{ __('confirmation.downloadedYourPlanTitle') }}</h1>

  <p class="govuk-body govuk-!-margin-top-6"><b>{{ __('confirmation.whatYouNeedToDoNext') }}</b> {{ __('confirmation.checkDownloadsFolder', { otherAdult: otherAdult }) }}</p>

      <h2 class="govuk-heading-m govuk-!-margin-top-6">
        {{ __('sharePlan.ifTheyDoNotRespond', {otherAdult: otherAdult}) }}
      </h2>
      <p class="govuk-body">{{ __('sharePlan.tryMediation', {otherAdult: otherAdult}) }}</p>

      <p class="govuk-body">
        {{ __('sharePlan.aMediatorIs') }}
      </p>

      <p class="govuk-body">
        <a href="https://www.gov.uk/looking-after-children-divorce/types-of-court-order" class="govuk-link"
          >{{ __('sharePlan.ifYouCannotAgree') }}</a
        >
      </p>

      <h2 class="govuk-heading-m govuk-!-margin-top-6">{{ __('confirmation.helpUsImprove') }}</h2>
      <p class="govuk-body">{{ __('confirmation.appreciateFeedback') }}</p>

      {% if feedbackUrl %}
      <p class="govuk-body govuk-!-margin-top-4">
        <a href="{{ feedbackUrl }}" class="govuk-link" target="_blank" rel="noopener noreferrer">{{ __('confirmation.whatDidYouThink') }}</a>
      </p>
      {% endif %}
    </div>

    <div class="govuk-grid-column-one-third">
      <hr class="govuk-!-margin-bottom-4 now-share-header" />
      <h2 class="govuk-heading-m govuk-!-margin-bottom-2">{{ __('confirmation.cantFindPlan') }}</h2>
      <p class="govuk-body govuk-!-margin-bottom-4">
        {{ __('confirmation.checkDownloads') }}
      </p>
      <p class="govuk-body"><a href="{{ paths.DOWNLOAD_PDF }}" class="govuk-link">{{ __('confirmation.downloadPdf') }}</a></p>
      <p class="govuk-body"><a href="{{ paths.DOWNLOAD_HTML }}" class="govuk-link">{{ __('confirmation.downloadHtml') }}</a></p>
    </div>
  </div>

  <script nonce="{{ cspNonce }}">
    (function() {
      'use strict';

      // Auto-trigger download when page loads
      // Use a unique key per plan attempt to allow multiple plans in the same browser session
      var downloadKey = 'downloadTriggered_' + '{{ planStartTime }}';

      // Check if this is the first visit to this page (not a refresh or back navigation)
      if (!sessionStorage.getItem(downloadKey)) {
        sessionStorage.setItem(downloadKey, 'true');

        // Get the format parameter from URL (defaults to 'pdf' for backward compatibility)
        var urlParams = new URLSearchParams(window.location.search);
        var format = urlParams.get('format') || 'pdf';

        // Determine which download URL to use
        var downloadUrl = format === 'html' ? '{{ paths.DOWNLOAD_HTML }}' : '{{ paths.DOWNLOAD_PDF }}';

        // Create a temporary link and trigger download
        var link = document.createElement('a');
        link.href = downloadUrl;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    })();
  </script>
{% endblock %}
