name: 'Playwright E2E Tests'

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to test against (development, staging, production)'
        required: true
        type: string
      base_url:
        description: 'Base URL to run tests against'
        required: true
        type: string
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test against'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      base_url:
        description: 'Base URL to run tests against'
        required: true
        type: string

permissions:
  contents: read

jobs:
  e2e_tests:
    name: "E2E Tests - ${{ inputs.environment || 'PR' }} (Shard ${{ matrix.shardIndex }}/${{ matrix.shardTotal }})"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        shardIndex: [1, 2, 3, 4, 5, 6]
        shardTotal: [6]

    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: 'Setup Node.js'
        uses: actions/setup-node@cdca7365b2dadb8aad0a33bc7601856ffabcc48e
        with:
          node-version-file: '.nvmrc'

      - name: 'Install Dependencies'
        run: npm ci --no-audit

      - name: 'Determine Browser'
        id: browser
        run: |
          BROWSERS=("chromium" "firefox" "webkit")
          INDEX=$(( (${{ github.run_number }} - 1) % 3 ))
          BROWSER=${BROWSERS[$INDEX]}
          echo "name=$BROWSER" >> $GITHUB_OUTPUT
          echo "üåê Running tests with: $BROWSER (run #${{ github.run_number }})"

      - name: 'Install Playwright Browser'
        run: npx playwright install --with-deps ${{ steps.browser.outputs.name }}

      - name: 'Run Playwright E2E Tests (PR - Local)'
        if: github.event_name == 'pull_request'
        run: npm run e2e -- --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}

      - name: 'Run Playwright E2E Tests (Against Environment)'
        if: inputs.base_url
        run: npm run e2e -- --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}
        env:
          BASE_URL: ${{ inputs.base_url }}

      - name: 'Upload Playwright Report'
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882
        with:
          name: playwright-report-${{ inputs.environment || 'pr' }}-shard-${{ matrix.shardIndex }}-${{ github.run_number }}
          path: playwright-report/
          retention-days: 30

      - name: 'Upload Test Results'
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882
        with:
          name: playwright-results-${{ inputs.environment || 'pr' }}-shard-${{ matrix.shardIndex }}-${{ github.run_number }}
          path: playwright-results.xml
          retention-days: 30
